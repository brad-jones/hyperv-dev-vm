variables:
  # Use this just like you would a docker image tag to create different versions
  # of the VM image otherwise the image will be overwritten each build.
  tag: latest

  # The ssh credentials to use to connect the provisioners
  ssh_username: packer
  ssh_private_key_file: ~/.ssh/id_rsa

  # The EC2 instance type that will be used for the build,
  # irrelevant for other builders.
  instance_type: t3.micro

  # Select a VPC and Subnet to use for the EC2 instance,
  # irrelevant for other builders.
  vpc_filter: "*"
  subnet_filter: "*"

builders:
  - type: amazon-ebs
    instance_type: "{{user `instance_type`}}"
    ami_name: dev-servercore-{{user `tag`}}
    ami_description: A Windows 2019 Server Core development environment
    source_ami_filter:
      most_recent: true
      owners: ["amazon"]
      filters:
        architecture: x86_64
        virtualization-type: hvm
        root-device-type: ebs
        platform: windows
        name: Windows_Server-2019-English-Core-Base*
    force_deregister: true
    force_delete_snapshot: true
    user_data_file: ./userdata.ps1
    communicator: ssh
    ssh_username: "{{user `ssh_username`}}"
    ssh_private_key_file: "{{user `ssh_private_key_file`}}"
    vpc_filter:
      filters:
        "tag:Name": "{{user `vpc_filter`}}"
    subnet_filter:
      most_free: true
      random: true
      filters:
        "tag:Name": "{{user `subnet_filter`}}"
    tags:
      Name: dev-servercore-{{user `tag`}}

provisioners:
  - type: powershell
    # see: https://github.com/hashicorp/packer/issues/6664
    execute_command: "$ErrorPreference='Stop';$ProgressPreference='SilentlyContinue';. {{.Vars}};. {{.Path}}; exit $LastExitCode"
    scripts: provisioner.ps1
